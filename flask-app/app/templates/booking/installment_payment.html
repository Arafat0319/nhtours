{% extends "base.html" %}

{% block title %}Installment Payment | Checkout{% endblock %}

{% block content %}
{# Hero背景区域 #}
<div class="w-full h-[70vh]" style="background-image: url('{{ url_for('static', filename='images/backgrounds/tibet_background.jpg') }}'); background-position: center; background-size: cover; background-repeat: no-repeat;">
</div>

<div class="w-full h-[16px] bg-indigo-800"></div>

{# 主要内容区域 #}
<div class="max-w-6xl mx-auto py-8 px-8 md:px-0">
    {# Breadcrumb导航 #}
    <nav class="mb-8">
        <ol class="flex flex-wrap items-center space-x-2 text-lg font-medium text-amber-800">
            <li class="flex items-center">
                <a class="hover:underline" href="{{ url_for('main.index') }}">Home</a>
            </li>
            <li class="flex items-center">
                <span class="mx-2 text-gray-400">
                    <svg class="feather feather-chevron-right" fill="none" height="18" stroke="currentColor"
                        stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="18"
                        xmlns="http://www.w3.org/2000/svg">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </span>
                <span class="text-indigo-800 font-medium cursor-default">Installment Payment</span>
            </li>
        </ol>
    </nav>
</div>

{# 支付表单区域 #}
<div class="max-w-xl mx-auto px-8 md:px-0 pb-16">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2 space-y-6">
            <div>
                <h2 class="text-2xl font-medium text-zinc-800 mb-2 uppercase tracking-wide">Installment Payment</h2>
                <p class="content mb-2">Card fees apply to credit cards: Visa/Mastercard 2.9%, AmEx 3.5%. Debit or prepaid cards have no fee.</p>
                <p class="text-sm text-zinc-500">Complete your payment below to finish this installment.</p>
            </div>

            {# 卡片详情 #}
            <div class="bg-white border border-zinc-300 rounded-xs p-6 space-y-4">
                <h3 class="text-lg font-medium text-zinc-800">Card Details</h3>
                <div id="payment-element" class="rounded-xs p-3"></div>
                <div id="payment-message" class="text-sm text-red-600 hidden"></div>
            </div>
        </div>

        {# 订单摘要侧边栏 #}
        <div class="lg:col-span-1">
            <div class="bg-white border border-zinc-300 rounded-xs p-6 space-y-4 h-fit">
                <h3 class="text-lg font-medium text-zinc-800">Order Summary</h3>
                
                {# 预订信息 #}
                <div class="space-y-2 pb-4 border-b border-zinc-200">
                    <div class="text-base text-zinc-600">Booking #{{ booking.id }}</div>
                    {% if booking.trip %}
                    <div class="text-base text-zinc-600">{{ booking.trip.title }}</div>
                    {% endif %}
                </div>

                {# 金额明细 #}
                <div class="space-y-2">
                    {% if summary_items %}
                        {% for item in summary_items %}
                        <div class="flex justify-between text-base text-zinc-600">
                            <span>{{ item.label }}</span>
                            <span id="summary-item-amount" data-base-amount="{{ item.amount_cents }}">${{ "%.2f"|format(item.amount_cents / 100) }}</span>
                        </div>
                        {% endfor %}
                    {% endif %}
                    <div class="flex justify-between text-base text-zinc-600">
                        <span>Fee</span>
                        <span id="summary-fee">$0.00</span>
                    </div>
                    <div class="flex justify-between text-lg font-semibold border-t border-zinc-200 pt-2 text-zinc-800">
                        <span>Total</span>
                        <span id="summary-total">${{ "%.2f"|format(base_amount_cents / 100) }}</span>
                    </div>
                </div>

                {# 剩余余额 - 改为勾选框 #}
                {% if remaining_amount_cents and remaining_amount_cents > 0 %}
                <div class="pt-4 border-t border-zinc-200">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="text-base text-zinc-700 font-medium">
                                Remaining Balance
                            </div>
                            <div class="text-sm text-zinc-500 mt-0.5">
                                $<span id="remaining-balance-amount">{{ "%.2f"|format(remaining_amount_cents / 100) }}</span>
                            </div>
                        </div>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <span class="text-base text-zinc-700 font-medium">Pay Off</span>
                            <input type="checkbox" id="payoff-checkbox" class="w-4 h-4 text-amber-800 border-zinc-300 rounded focus:ring-amber-800 focus:ring-1 cursor-pointer">
                        </label>
                    </div>
                </div>
                {% endif %}
            </div>

            {# Place Order 按钮 - 放在 Order Summary 外面 #}
            <button id="place-order-btn"
                class="w-full px-4 py-4 bg-amber-800 text-white uppercase tracking-tight font-semibold text-lg rounded-xs hover:bg-amber-800/90 transition-colors mt-4 mb-8">
                Place Order
            </button>
        </div>
    </div>
</div>

{# 支付元素样式 #}
<style>
    #payment-element,
    #payment-element .StripeElement,
    #payment-element .StripeElement--focus {
        border: none !important;
        box-shadow: none !important;
        outline: none !important;
    }
</style>

<script src="https://js.stripe.com/v3/"></script>
<script>
    window.checkoutConfig = {
        bookingId: {% if booking and booking.id %}{{ booking.id }}{% else %}null{% endif %},
        installmentId: {% if installment and installment.id %}{{ installment.id }}{% else %}null{% endif %},
        clientSecret: {% if client_secret %}"{{ client_secret }}"{% else %}null{% endif %},
        publishableKey: {% if publishable_key %}"{{ publishable_key }}"{% else %}null{% endif %},
        successUrl: "{{ success_url }}",
        paymentIntentId: "{{ payment_intent_id or '' }}",
        baseAmountCents: {{ base_amount_cents }},
        remainingAmountCents: {% if remaining_amount_cents %}{{ remaining_amount_cents }}{% else %}0{% endif %},
        paymentPlan: "{{ payment_plan }}",
        mode: "{{ payment_mode }}",
        paymentStep: "{{ payment_step }}"
    };
    // 调试信息
    console.log('Checkout Config:', {
        hasClientSecret: !!window.checkoutConfig.clientSecret,
        hasPublishableKey: !!window.checkoutConfig.publishableKey,
        clientSecretPreview: window.checkoutConfig.clientSecret ? window.checkoutConfig.clientSecret.substring(0, 20) + '...' : null,
        publishableKeyPreview: window.checkoutConfig.publishableKey ? window.checkoutConfig.publishableKey.substring(0, 20) + '...' : null
    });
</script>
<script src="{{ url_for('static', filename='js/payment.js') }}"></script>
{% endblock %}
