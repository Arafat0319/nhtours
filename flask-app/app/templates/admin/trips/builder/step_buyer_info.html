{% extends "admin/trips/builder/base_builder.html" %}

{% block builder_step_content %}
<div class="max-w-4xl mx-auto">
    <div class="mb-6">
        <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl sm:tracking-tight">Buyer
            Information</h2>
        <p class="mt-1 text-sm text-gray-500">Configure which buyer information fields to collect during the booking process.</p>
    </div>

    <form method="POST" id="buyerInfoForm">
        {{ form.hidden_tag() }}
        {{ form.fields_json(id="fields_json") }}

        <!-- Main Card: Buyer Info Fields -->
        <div class="bg-white shadow sm:rounded-lg border border-gray-200 overflow-hidden">
            <!-- Header -->
            <div class="px-4 py-5 sm:px-6 border-b border-gray-200 flex justify-between items-start bg-white">
                <div>
                    <h3 class="text-lg font-medium leading-6 text-gray-900">Configured Fields</h3>
                    <p class="mt-1 text-sm text-gray-500">Default required fields and custom fields that will appear on the booking form</p>
                </div>
            </div>

            <!-- Fields List -->
            <div class="bg-white">
                <ul role="list" class="divide-y divide-gray-100">
                    <!-- Default Mandatory Fields -->
                    <li class="px-4 py-4 sm:px-6 flex items-center justify-between hover:bg-gray-50">
                        <div class="flex items-center gap-3">
                            <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"
                                    clip-rule="evenodd" />
                            </svg>
                            <span class="text-sm font-medium text-gray-900">First Name <span
                                    class="text-red-500">*</span></span>
                        </div>
                        <span class="text-sm text-gray-400 italic">Required by default</span>
                    </li>
                    <li class="px-4 py-4 sm:px-6 flex items-center justify-between hover:bg-gray-50">
                        <div class="flex items-center gap-3">
                            <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"
                                    clip-rule="evenodd" />
                            </svg>
                            <span class="text-sm font-medium text-gray-900">Last Name <span
                                    class="text-red-500">*</span></span>
                        </div>
                        <span class="text-sm text-gray-400 italic">Required by default</span>
                    </li>
                    <li class="px-4 py-4 sm:px-6 flex items-center justify-between hover:bg-gray-50">
                        <div class="flex items-center gap-3">
                            <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"
                                    clip-rule="evenodd" />
                            </svg>
                            <span class="text-sm font-medium text-gray-900">Email <span
                                    class="text-red-500">*</span></span>
                        </div>
                        <span class="text-sm text-gray-400 italic">Required by default</span>
                    </li>
                    <li class="px-4 py-4 sm:px-6 flex items-center justify-between hover:bg-gray-50">
                        <div class="flex items-center gap-3">
                            <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"
                                    clip-rule="evenodd" />
                            </svg>
                            <span class="text-sm font-medium text-gray-900">Phone <span
                                    class="text-red-500">*</span></span>
                        </div>
                        <span class="text-sm text-gray-400 italic">Required by default</span>
                    </li>

                    <!-- Default Optional Field Groups -->
                    <!-- Address Information -->
                    <li class="border-t border-gray-200">
                        <div class="px-4 py-4 sm:px-6 flex items-center justify-between hover:bg-gray-50">
                            <div class="flex items-center gap-3 flex-1">
                                <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
                                        clip-rule="evenodd" />
                                </svg>
                                <span class="text-sm font-medium text-gray-900">Address Information</span>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="enable-address" class="sr-only peer" onchange="toggleDefaultField('address', this.checked)">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-wetravel-cyan/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-wetravel-cyan"></div>
                            </label>
                        </div>
                        <!-- Expanded content for Address Information -->
                        <div id="address-details" class="hidden px-4 pb-4 sm:px-6 bg-gray-50 border-t border-gray-100">
                            <div class="pt-3 space-y-2">
                                <p class="text-xs font-medium text-gray-700 mb-2">Includes the following fields:</p>
                                <div class="grid grid-cols-2 gap-2 text-xs text-gray-600">
                                    <div class="flex items-center gap-2">
                                        <span>Address</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span>City</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span>State/Province</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span>ZIP/Postal Code</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span>Country</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </li>
                    <!-- Emergency Contact -->
                    <li>
                        <div class="px-4 py-4 sm:px-6 flex items-center justify-between hover:bg-gray-50">
                            <div class="flex items-center gap-3 flex-1">
                                <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" />
                                </svg>
                                <span class="text-sm font-medium text-gray-900">Emergency Contact</span>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="enable-emergency" class="sr-only peer" onchange="toggleDefaultField('emergency', this.checked)">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-wetravel-cyan/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-wetravel-cyan"></div>
                            </label>
                        </div>
                        <!-- Expanded content for Emergency Contact -->
                        <div id="emergency-details" class="hidden px-4 pb-4 sm:px-6 bg-gray-50 border-t border-gray-100">
                            <div class="pt-3 space-y-2">
                                <p class="text-xs font-medium text-gray-700 mb-2">Includes the following fields:</p>
                                <div class="grid grid-cols-2 gap-2 text-xs text-gray-600">
                                    <div class="flex items-center gap-2">
                                        <span>Contact Name</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span>Phone</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </li>

                    <!-- Dynamic Custom Fields Container -->
                    <div id="custom-fields-container">
                        <!-- Populated by JS -->
                    </div>
                </ul>

                <!-- Add Field Row -->
                <div class="px-4 py-4 sm:px-6 bg-white border-t border-gray-100">
                    <button type="button" onclick="openFieldModal()"
                        class="flex items-center text-wetravel-cyan hover:text-wetravel-cyan-dark font-medium text-sm">
                        <svg class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z"
                                clip-rule="evenodd" />
                        </svg>
                        Add custom field
                    </button>
                </div>
            </div>
        </div>

        <div class="mt-6 flex items-center justify-end gap-x-6">
            <a href="{{ url_for('admin.trip_builder', id=trip.id, step='addons') }}"
                class="text-sm font-semibold leading-6 text-gray-900">Back</a>
            <button type="submit"
                class="rounded-md bg-wetravel-cyan px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-wetravel-cyan-dark focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-wetravel-cyan">Save
                & Continue</button>
        </div>
    </form>
</div>

<!-- Modal -->
<div id="fieldModal" class="relative z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center">
            <div
                class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:w-full sm:max-w-lg">
                <!-- Close Button -->
                <div class="absolute right-4 top-4">
                    <button type="button" onclick="closeFieldModal()" class="text-gray-400 hover:text-gray-500">
                        <span class="sr-only">Close</span>
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <div class="bg-white px-4 pb-4 pt-5 sm:p-6 pb-4">
                    <h3 class="text-lg font-semibold leading-6 text-gray-900 mb-6" id="modal-title">Add Field</h3>

                    <div class="space-y-5">
                        <input type="hidden" id="f_id">

                        <!-- Field Type & Required Row -->
                        <div class="flex items-start gap-6">
                            <div class="flex-1">
                                <label class="block text-sm font-medium leading-6 text-gray-900 mb-2">Field
                                    Type</label>
                                <select id="f_type" onchange="toggleOptionField()"
                                    class="block w-full rounded-md border-0 h-9 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-wetravel-cyan sm:text-sm sm:leading-6">
                                    <option value="text">Text</option>
                                    <option value="textarea">Long Text</option>
                                    <option value="email">Email</option>
                                    <option value="phone">Phone</option>
                                    <option value="address">Address</option>
                                    <option value="date">Date</option>
                                    <option value="select">Multiple Choice (Dropdown)</option>
                                </select>
                            </div>

                            <!-- Required Toggle (Yes/No Button Group) -->
                            <div>
                                <label class="block text-sm font-medium leading-6 text-gray-900 mb-2">Required?</label>
                                <div class="flex rounded-md shadow-sm" role="group">
                                    <button type="button" onclick="toggleRequired(true)" id="btn-req-yes"
                                        class="px-3 py-1.5 text-sm font-medium rounded-l-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 focus:z-10 focus:ring-1 focus:ring-wetravel-cyan">
                                        Yes
                                    </button>
                                    <button type="button" onclick="toggleRequired(false)" id="btn-req-no"
                                        class="px-3 py-1.5 text-sm font-medium rounded-r-md border border-l-0 border-gray-300 bg-gray-100 text-gray-900 hover:bg-gray-200 focus:z-10 focus:ring-1 focus:ring-wetravel-cyan">
                                        No
                                    </button>
                                </div>
                                <input type="hidden" id="f_required_val" value="false">
                            </div>
                        </div>

                        <!-- Field Name -->
                        <div class="border-t border-gray-200 pt-5">
                            <label class="block text-sm font-medium leading-6 text-gray-900 mb-2">Field Name</label>
                            <input type="text" id="f_name"
                                class="block w-full rounded-md border-0 h-9 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-wetravel-cyan sm:text-sm sm:leading-6"
                                placeholder="e.g. Address, Emergency Contact">
                        </div>

                        <!-- Options (Conditional) -->
                        <div id="options_container" class="hidden border-t border-gray-200 pt-5">
                            <label class="block text-sm font-medium leading-6 text-gray-900 mb-2">Options (Comma
                                separated)</label>
                            <textarea id="f_options" rows="3"
                                class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-wetravel-cyan sm:text-sm sm:leading-6"
                                placeholder="Option A, Option B"></textarea>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 border-t border-gray-100">
                    <button type="button" onclick="saveField()"
                        class="inline-flex w-full justify-center rounded-md bg-wetravel-green px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-600 sm:ml-3 sm:w-auto">Save
                        Field</button>
                    <button type="button" onclick="closeFieldModal()"
                        class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">Cancel</button>
                    <button type="button" id="deleteBtn" onclick="deleteCurrentField()"
                        class="hidden mt-3 inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:mt-0 sm:ml-3 sm:w-auto">Delete</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let fields = [];
    let currentEditIndex = -1;
    let isRequired = false;

    const listContainer = document.getElementById('custom-fields-container');
    const hiddenInput = document.getElementById('fields_json');
    const optionsContainer = document.getElementById('options_container');
    
    // 初始化 fields 数组：优先从 hiddenInput 读取，如果没有则从模板数据读取
    function initializeFields() {
        try {
            // 首先尝试从 hiddenInput 读取（这是最可靠的数据源）
            if (hiddenInput && hiddenInput.value) {
                const parsed = JSON.parse(hiddenInput.value);
                if (Array.isArray(parsed)) {
                    fields = parsed;
                    return;
                }
            }
            
            // 如果 hiddenInput 没有值，从模板数据读取
            const templateData = {{ form.fields_json.data|tojson if form.fields_json.data else '[]' }};
            if (typeof templateData === 'string') {
                fields = JSON.parse(templateData);
            } else if (Array.isArray(templateData)) {
                fields = templateData;
            } else {
                fields = [];
            }
            
            // 确保 hiddenInput 的值与 fields 数组同步
            if (hiddenInput) {
                hiddenInput.value = JSON.stringify(fields);
            }
        } catch (e) {
            console.error('Error initializing fields:', e);
            fields = [];
            if (hiddenInput) {
                hiddenInput.value = '[]';
            }
        }
    }
    
    // 立即初始化（在 DOM 加载前）
    initializeFields();

    // Field Logic
    function toggleOptionField() {
        const type = document.getElementById('f_type').value;
        if (type === 'select') {
            optionsContainer.classList.remove('hidden');
        } else {
            optionsContainer.classList.add('hidden');
        }
    }

    function toggleRequired(val) {
        isRequired = val;
        const btnYes = document.getElementById('btn-req-yes');
        const btnNo = document.getElementById('btn-req-no');

        if (val) {
            btnYes.className = "px-3 py-1.5 text-sm font-medium rounded-l-md border border-gray-300 bg-wetravel-cyan text-white hover:bg-cyan-600 focus:z-10 focus:ring-1 focus:ring-wetravel-cyan";
            btnNo.className = "px-3 py-1.5 text-sm font-medium rounded-r-md border border-l-0 border-gray-300 bg-white text-gray-700 hover:bg-gray-50 focus:z-10 focus:ring-1 focus:ring-wetravel-cyan";
        } else {
            btnYes.className = "px-3 py-1.5 text-sm font-medium rounded-l-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 focus:z-10 focus:ring-1 focus:ring-wetravel-cyan";
            btnNo.className = "px-3 py-1.5 text-sm font-medium rounded-r-md border border-l-0 border-gray-300 bg-gray-100 text-gray-900 hover:bg-gray-200 focus:z-10 focus:ring-1 focus:ring-wetravel-cyan";
        }
    }

    // 初始化默认字段组状态
    function initDefaultFields() {
        // 检查是否有 address 类型的字段
        const hasAddress = fields.some(f => f.field_type === 'address');
        const addressCheckbox = document.getElementById('enable-address');
        const addressDetails = document.getElementById('address-details');
        if (addressCheckbox) {
            addressCheckbox.checked = hasAddress;
            if (hasAddress && addressDetails) {
                addressDetails.classList.remove('hidden');
            }
        }
        
        // 检查是否有 emergency_contact 类型的字段
        const hasEmergency = fields.some(f => f.field_type === 'emergency_contact');
        const emergencyCheckbox = document.getElementById('enable-emergency');
        const emergencyDetails = document.getElementById('emergency-details');
        if (emergencyCheckbox) {
            emergencyCheckbox.checked = hasEmergency;
            if (hasEmergency && emergencyDetails) {
                emergencyDetails.classList.remove('hidden');
            }
        }
    }

    // 切换默认字段组
    function toggleDefaultField(type, enabled) {
        if (type === 'address') {
            const detailsDiv = document.getElementById('address-details');
            if (enabled) {
                // 检查是否已存在
                const exists = fields.some(f => f.field_type === 'address');
                if (!exists) {
                    fields.push({
                        id: null,
                        field_name: 'Address Information',
                        field_type: 'address',
                        options: null,
                        is_required: false,
                        display_order: fields.length
                    });
                }
                // 展开显示详情
                if (detailsDiv) {
                    detailsDiv.classList.remove('hidden');
                }
            } else {
                // 移除 address 类型的字段
                fields = fields.filter(f => f.field_type !== 'address');
                // 隐藏详情
                if (detailsDiv) {
                    detailsDiv.classList.add('hidden');
                }
            }
            renderFields();
        } else if (type === 'emergency') {
            const detailsDiv = document.getElementById('emergency-details');
            if (enabled) {
                // 检查是否已存在
                const exists = fields.some(f => f.field_type === 'emergency_contact');
                if (!exists) {
                    fields.push({
                        id: null,
                        field_name: 'Emergency Contact',
                        field_type: 'emergency_contact',
                        options: null,
                        is_required: false,
                        display_order: fields.length
                    });
                }
                // 展开显示详情
                if (detailsDiv) {
                    detailsDiv.classList.remove('hidden');
                }
            } else {
                // 移除 emergency_contact 类型的字段
                fields = fields.filter(f => f.field_type !== 'emergency_contact');
                // 隐藏详情
                if (detailsDiv) {
                    detailsDiv.classList.add('hidden');
                }
            }
            renderFields();
        }
    }

    function renderFields() {
        hiddenInput.value = JSON.stringify(fields);
        listContainer.innerHTML = '';

        // 默认必填字段名称和 display_order（这些字段在 HTML 中硬编码显示，不需要在自定义字段列表中显示）
        // display_order: 0=First Name, 1=Last Name, 2=Email, 3=Phone
        const defaultFields = [
            { name: 'First Name', order: 0 },
            { name: 'Last Name', order: 1 },
            { name: 'Email', order: 2 },
            { name: 'Phone', order: 3 }
        ];
        
        // 只渲染自定义字段：
        // 1. 排除 address 和 emergency_contact 类型（这些是字段组，有专门的开关）
        // 2. 排除默认必填字段（基于名称和 display_order 的组合）
        const customFields = fields.filter(f => {
            const isAddressOrEmergency = f.field_type === 'address' || f.field_type === 'emergency_contact';
            
            // 检查是否是默认字段：名称匹配且 display_order 匹配
            const isDefaultField = defaultFields.some(df => {
                const nameMatch = f.field_name && f.field_name.toLowerCase().trim() === df.name.toLowerCase().trim();
                const orderMatch = f.display_order === df.order;
                return nameMatch && orderMatch;
            });
            
            return !isAddressOrEmergency && !isDefaultField;
        });
        
        customFields.forEach((item, index) => {
            // 找到原始索引
            const originalIndex = fields.indexOf(item);
            
            const li = document.createElement('li');
            li.className = "px-4 py-4 sm:px-6 flex items-center justify-between hover:bg-gray-50 border-t border-gray-100 cursor-pointer group";
            li.onclick = (e) => {
                editField(originalIndex);
            };

            li.innerHTML = `
                <div class="flex items-center gap-3">
                    <!-- Grab Icon (Visual Only) -->
                    <svg class="h-5 w-5 text-gray-300 cursor-move" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
                    </svg>
                    <div>
                        <span class="text-sm font-medium text-gray-900">${item.field_name} ${item.is_required ? '<span class="text-red-500">*</span>' : ''}</span>
                        <p class="text-xs text-gray-500 capitalize">${item.field_type}</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                     <button type="button" class="text-gray-400 hover:text-wetravel-cyan">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>
                    </button>
                    <button type="button" onclick="event.stopPropagation(); deleteField(${originalIndex})" class="text-gray-400 hover:text-red-600">
                         <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                    <button type="button" class="text-gray-400 hover:text-gray-600">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                        </svg>
                    </button>
                </div>
            `;
            listContainer.appendChild(li);
        });
    }

    function openFieldModal() {
        currentEditIndex = -1;
        document.getElementById('modal-title').innerText = 'Add Field';
        document.getElementById('f_id').value = '';
        document.getElementById('f_name').value = '';
        document.getElementById('f_type').value = 'text';
        document.getElementById('f_options').value = '';
        toggleRequired(false);

        toggleOptionField();
        document.getElementById('deleteBtn').classList.add('hidden');
        document.getElementById('fieldModal').classList.remove('hidden');
    }

    function editField(index) {
        currentEditIndex = index;
        const item = fields[index];
        document.getElementById('modal-title').innerText = 'Edit Field';
        document.getElementById('f_id').value = item.id || '';
        document.getElementById('f_name').value = item.field_name;
        document.getElementById('f_type').value = item.field_type;

        let opts = item.options;
        if (Array.isArray(opts)) opts = opts.join(', ');
        document.getElementById('f_options').value = opts || '';

        toggleRequired(item.is_required);

        toggleOptionField();
        document.getElementById('deleteBtn').classList.remove('hidden');
        document.getElementById('fieldModal').classList.remove('hidden');
    }

    function closeFieldModal() {
        document.getElementById('fieldModal').classList.add('hidden');
    }

    async function saveField() {
        const fieldName = document.getElementById('f_name').value;
        const fieldType = document.getElementById('f_type').value;
        if (!fieldName) {
            await customAlert('Field Name is required', 'Validation Error');
            return;
        }

        let options = null;
        if (fieldType === 'select') {
            const rawOpts = document.getElementById('f_options').value;
            if (rawOpts) {
                options = rawOpts.split(',').map(s => s.trim()).filter(s => s.length > 0);
            }
        }

        const data = {
            id: document.getElementById('f_id').value ? parseInt(document.getElementById('f_id').value) : null,
            field_name: fieldName,
            field_type: fieldType,
            options: options,
            is_required: isRequired,
            display_order: currentEditIndex === -1 ? fields.length : currentEditIndex
        };

        if (currentEditIndex === -1) {
            fields.push(data);
        } else {
            if (fields[currentEditIndex].id) {
                data.id = fields[currentEditIndex].id;
            }
            data.display_order = fields[currentEditIndex].display_order || currentEditIndex;
            fields[currentEditIndex] = data;
        }

        renderFields();
        closeFieldModal();
    }

    async function deleteField(index) {
        const confirmed = await customConfirm('Are you sure you want to delete this field? This action cannot be undone.', 'Delete Field', 'danger');
        if (confirmed) {
            fields.splice(index, 1);
            renderFields();
        }
    }

    async function deleteCurrentField() {
        if (currentEditIndex > -1) {
            const confirmed = await customConfirm('Are you sure you want to delete this field? This action cannot be undone.', 'Delete Field', 'danger');
            if (confirmed) {
                fields.splice(currentEditIndex, 1);
                renderFields();
                closeFieldModal();
            }
        }
    }

    // 表单提交前确保更新 hidden input
    document.getElementById('buyerInfoForm').addEventListener('submit', function(e) {
        // 确保 fields 数据已同步到 hidden input
        hiddenInput.value = JSON.stringify(fields);
    });

    // Init Logic
    document.addEventListener('DOMContentLoaded', () => {
        // 再次确保 fields 数组正确初始化（DOM 加载后）
        if (!Array.isArray(fields)) {
            console.warn('Fields data is not an array, re-initializing');
            initializeFields();
        }
        
        // 确保 hiddenInput 的值与 fields 数组同步
        if (hiddenInput && hiddenInput.value !== JSON.stringify(fields)) {
            hiddenInput.value = JSON.stringify(fields);
        }
        
        renderFields();
        initDefaultFields();
    });

</script>
{% endblock %}
