{% extends "admin/trips/builder/base_builder.html" %}

{% block builder_step_content %}
<div class="max-w-4xl mx-auto">
    <div class="md:flex md:items-center md:justify-between mb-6">
        <div class="min-w-0 flex-1">
            <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl sm:tracking-tight">Optional
                Add-ons</h2>
            <p class="mt-1 text-sm text-gray-500">Create optional extras that participants can add to their trip (e.g.,
                Single Supplement, Equipment Rental).</p>
        </div>
        <div class="mt-4 flex md:ml-4 md:mt-0">
            <button type="button" onclick="openAddonModal()"
                class="inline-flex items-center rounded-md bg-wetravel-cyan px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-wetravel-cyan-dark focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-wetravel-cyan">
                <svg class="-ml-0.5 mr-1.5 h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path
                        d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                </svg>
                Create Add-on
            </button>
        </div>
    </div>

    <form method="POST" id="addonsForm">
        {{ form.hidden_tag() }}
        <!-- Hidden field to store JSON data -->
        {{ form.addons_json(id="addons_json") }}

        <!-- Add-ons List Container -->
        <div id="addons-list" class="space-y-4">
            <!-- JS will populate this -->
            <div id="empty-state" class="text-center py-12 bg-white rounded-lg border-2 border-dashed border-gray-300">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1"
                        d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h3 class="mt-2 text-sm font-semibold text-gray-900">No add-ons</h3>
                <p class="mt-1 text-sm text-gray-500">Add optional items for your participants.</p>
                <div class="mt-6">
                    <button type="button" onclick="openAddonModal()"
                        class="inline-flex items-center rounded-md bg-wetravel-cyan px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-wetravel-cyan-dark focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-wetravel-cyan">
                        Create Add-on
                    </button>
                </div>
            </div>
        </div>

        <div class="mt-6 flex items-center justify-end gap-x-6">
            <a href="{{ url_for('admin.trip_builder', id=trip.id, step='packages') }}"
                class="text-sm font-semibold leading-6 text-gray-900">Back</a>
            <button type="submit"
                class="rounded-md bg-wetravel-cyan px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-wetravel-cyan-dark focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-wetravel-cyan">Save
                & Continue</button>
        </div>
    </form>
</div>

<!-- Modal -->
<div id="addonModal" class="relative z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity backdrop-blur-sm"></div>

    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div
                class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                <!-- Header -->
                <div class="bg-gray-50 px-4 py-3 sm:px-6 flex justify-between items-center border-b border-gray-200">
                    <h3 class="text-lg font-semibold leading-6 text-gray-900" id="modal-title">Add-on Details</h3>
                    <button type="button" onclick="closeAddonModal()" class="text-gray-400 hover:text-gray-500">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- Scrollable Content -->
                <div class="px-4 py-5 sm:p-6 max-h-[80vh] overflow-y-auto">
                    <input type="hidden" id="addon_id">
                    
                    <div class="space-y-6">
                        <!-- 1. Basic Info -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium leading-6 text-gray-900 mb-2">Name</label>
                                <input type="text" id="addon_name"
                                    class="block w-full rounded-md border-0 h-9 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-wetravel-cyan sm:text-sm sm:leading-6"
                                    placeholder="e.g. Airport Transfer">
                            </div>
                            <div>
                                <label class="block text-sm font-medium leading-6 text-gray-900 mb-2">Description <span
                                    class="text-gray-400 font-normal">(optional)</span></label>
                                <textarea id="addon_description" rows="3"
                                    class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-wetravel-cyan sm:text-sm sm:leading-6"
                                    placeholder="Briefly describe what's included"></textarea>
                            </div>
                        </div>

                        <!-- 2. Pricing -->
                        <div class="border-t border-gray-200 pt-5">
                            <label class="block text-sm font-medium leading-6 text-gray-900 mb-2">Price ($)</label>
                            <input type="text" id="addon_price" inputmode="numeric" pattern="[0-9]*\.?[0-9]*"
                                class="block w-full rounded-md border-0 h-9 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-wetravel-cyan sm:text-sm sm:leading-6"
                                placeholder="0.00">
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 border-t border-gray-200">
                    <button type="button" onclick="saveAddon()"
                        class="inline-flex w-full justify-center rounded-md bg-wetravel-cyan px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-wetravel-cyan-dark transition-colors sm:ml-3 sm:w-auto">Save</button>
                    <button type="button" onclick="closeAddonModal()"
                        class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 transition-colors sm:mt-0 sm:w-auto">Cancel</button>
                    <button type="button" id="deleteBtn" onclick="deleteCurrentAddon()"
                        class="hidden mt-3 inline-flex w-full justify-center rounded-md bg-red-50 text-red-600 border border-red-200 px-3 py-2 text-sm font-semibold shadow-sm hover:bg-red-100 transition-colors sm:mt-0 sm:mr-auto sm:w-auto">Delete</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Initial Data
    let addons = [];
    let currentEditIndex = -1;

    const listContainer = document.getElementById('addons-list');
    const emptyState = document.getElementById('empty-state');
    const hiddenInput = document.getElementById('addons_json');
    
    // 初始化 addons 数组：优先从 hiddenInput 读取，如果没有则从模板数据读取
    function initializeAddons() {
        try {
            // 首先尝试从 hiddenInput 读取（这是最可靠的数据源）
            if (hiddenInput && hiddenInput.value) {
                const parsed = JSON.parse(hiddenInput.value);
                if (Array.isArray(parsed)) {
                    addons = parsed;
                    return;
                }
            }
            
            // 如果 hiddenInput 没有值，从模板数据读取
            const templateData = {{ form.addons_json.data|tojson if form.addons_json.data else '[]' }};
            if (typeof templateData === 'string') {
                addons = JSON.parse(templateData);
            } else if (Array.isArray(templateData)) {
                addons = templateData;
            } else {
                addons = [];
            }
            
            // 确保 hiddenInput 的值与 addons 数组同步
            if (hiddenInput) {
                hiddenInput.value = JSON.stringify(addons);
            }
        } catch (e) {
            console.error('Error initializing addons:', e);
            addons = [];
            if (hiddenInput) {
                hiddenInput.value = '[]';
            }
        }
    }
    
    // 立即初始化（在 DOM 加载前）
    initializeAddons();
    
    // Disable mouse wheel and middle click for addon_price input
    document.addEventListener('DOMContentLoaded', function() {
        const addonPriceInput = document.getElementById('addon_price');
        if (addonPriceInput) {
            addonPriceInput.addEventListener('wheel', function(e) {
                e.preventDefault();
            });
            addonPriceInput.addEventListener('mousedown', function(e) {
                if (e.button === 1) {
                    e.preventDefault();
                }
            });
            addonPriceInput.addEventListener('input', function(e) {
                this.value = this.value.replace(/[^0-9.]/g, '');
                const parts = this.value.split('.');
                if (parts.length > 2) {
                    this.value = parts[0] + '.' + parts.slice(1).join('');
                }
            });
            addonPriceInput.addEventListener('paste', function(e) {
                const paste = (e.clipboardData || window.clipboardData).getData('text');
                const filteredPaste = paste.replace(/[^0-9.]/g, '');
                const parts = filteredPaste.split('.');
                const finalPaste = parts.length > 2 ? parts[0] + '.' + parts.slice(1).join('') : filteredPaste;
                document.execCommand('insertText', false, finalPaste);
                e.preventDefault();
            });
        }
    });

    function renderAddons() {
        hiddenInput.value = JSON.stringify(addons);

        if (addons.length === 0) {
            listContainer.innerHTML = '';
            listContainer.appendChild(emptyState);
            emptyState.classList.remove('hidden');
        } else {
            emptyState.classList.add('hidden');
            listContainer.innerHTML = '';
            listContainer.appendChild(emptyState);

            addons.forEach((item, index) => {
                const el = document.createElement('div');
                el.className = "bg-white border border-gray-200 rounded-lg shadow-sm p-4 flex justify-between items-center";
                el.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="h-10 w-10 flex-shrink-0 flex items-center justify-center rounded-full bg-cyan-100 text-wetravel-cyan">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                        </div>
                        <div>
                            <h4 class="text-base font-semibold text-gray-900">${item.name}</h4>
                            <p class="text-sm text-gray-500">${item.description || ''}</p>
                            <p class="text-sm font-medium text-gray-900 mt-1">$${item.price}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                         <button type="button" onclick="editAddon(${index})" class="text-gray-400 hover:text-wetravel-cyan p-2">
                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                        </button>
                    </div>
                `;
                listContainer.appendChild(el);
            });
        }
    }

    function openAddonModal() {
        currentEditIndex = -1;
        document.getElementById('modal-title').innerText = 'Create Add-on';
        document.getElementById('addon_id').value = '';
        document.getElementById('addon_name').value = '';
        document.getElementById('addon_description').value = '';
        document.getElementById('addon_price').value = '';
        document.getElementById('deleteBtn').classList.add('hidden');
        document.getElementById('addonModal').classList.remove('hidden');
    }

    function editAddon(index) {
        currentEditIndex = index;
        const item = addons[index];
        document.getElementById('modal-title').innerText = 'Edit Add-on';
        document.getElementById('addon_id').value = item.id || '';
        document.getElementById('addon_id').value = item.id || '';
        document.getElementById('addon_name').value = item.name;
        document.getElementById('addon_description').value = item.description || '';
        document.getElementById('addon_price').value = item.price;

        document.getElementById('deleteBtn').classList.remove('hidden');
        document.getElementById('addonModal').classList.remove('hidden');
    }

    function closeAddonModal() {
        document.getElementById('addonModal').classList.add('hidden');
    }

    async function saveAddon() {
        const name = document.getElementById('addon_name').value;
        const price = document.getElementById('addon_price').value;
        if (!name || !price) {
            await customAlert('Name and Price are required', 'Validation Error');
            return;
        }

        const data = {
            id: document.getElementById('addon_id').value ? parseInt(document.getElementById('addon_id').value) : null,
            name: name,
            price: price,
            description: document.getElementById('addon_description').value
        };

        if (currentEditIndex === -1) {
            addons.push(data);
        } else {
            if (addons[currentEditIndex].id) {
                data.id = addons[currentEditIndex].id;
            }
            addons[currentEditIndex] = data;
        }

        renderAddons();
        closeAddonModal();
    }

    async function deleteCurrentAddon() {
        if (currentEditIndex > -1) {
            const confirmed = await customConfirm('Are you sure you want to delete this add-on? This action cannot be undone.', 'Delete Add-on', 'danger');
            if (confirmed) {
                addons.splice(currentEditIndex, 1);
                renderAddons();
                closeAddonModal();
            }
        }
    }

    // Init Logic
    document.addEventListener('DOMContentLoaded', () => {
        // 再次确保 addons 数组正确初始化（DOM 加载后）
        if (!Array.isArray(addons)) {
            console.warn('Addons data is not an array, re-initializing');
            initializeAddons();
        }
        
        // 确保 hiddenInput 的值与 addons 数组同步
        if (hiddenInput && hiddenInput.value !== JSON.stringify(addons)) {
            hiddenInput.value = JSON.stringify(addons);
        }
        
        renderAddons();
    });
</script>
{% endblock %}