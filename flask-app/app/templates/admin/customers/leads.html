{% extends "admin/customers/base_customers.html" %}

{% block content %}
<div class="space-y-6">
    <!-- Header Section -->
    <div class="flex justify-between items-center">
        <div>
            <h2 class="text-2xl font-normal text-gray-500">Leads</h2>
            <p class="text-sm text-gray-400 mt-1">Manage potential customers from contact forms</p>
        </div>
        <div class="flex space-x-2">
            <button class="bg-wetravel-green text-white px-4 py-2 rounded text-sm font-bold flex items-center hover:bg-green-500 transition-colors">
                <span>Export</span>
                <svg class="ml-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Search and Filter Bar -->
    <div class="bg-white rounded-lg shadow-sm p-4">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-3 md:space-y-0 md:space-x-4">
            <!-- Search Input -->
            <div class="flex-1">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                    <input type="text" id="searchInput" placeholder="Search by name, email, phone or organization..."
                        class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-wetravel-cyan focus:border-wetravel-cyan sm:text-sm">
                </div>
            </div>
            <!-- Status Filter -->
            <div class="flex items-center space-x-2">
                <label class="text-sm text-gray-600 whitespace-nowrap">Filter by Status:</label>
                <select id="statusFilter" class="block w-full md:w-auto rounded-md border-gray-300 shadow-sm focus:border-wetravel-cyan focus:ring-wetravel-cyan sm:text-sm">
                    <option value="all">All</option>
                    <option value="new">New Leads</option>
                    <option value="replied">Replied</option>
                    <option value="converted">Converted</option>
                    <option value="archived">Archived</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-lg shadow-sm p-4">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-blue-100 rounded-lg p-3">
                    <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Total Leads</p>
                    <p class="text-2xl font-semibold text-gray-900">{{ stats.total }}</p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm p-4">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-yellow-100 rounded-lg p-3">
                    <svg class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">New Leads</p>
                    <p class="text-2xl font-semibold text-gray-900">{{ stats.new }}</p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm p-4">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-green-100 rounded-lg p-3">
                    <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Replied</p>
                    <p class="text-2xl font-semibold text-gray-900">{{ stats.replied }}</p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm p-4">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-purple-100 rounded-lg p-3">
                    <svg class="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Converted</p>
                    <p class="text-2xl font-semibold text-gray-900">{{ stats.converted }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Leads Table -->
    <div class="bg-white shadow overflow-hidden sm:rounded-lg">
        <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 table-fixed">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 18%;">
                        Name / Email
                    </th>
                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 10%;">
                        Phone
                    </th>
                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 10%;">
                        Organization
                    </th>
                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 10%;">
                        Interest
                    </th>
                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 20%;">
                        Message
                    </th>
                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 8%;">
                        Status
                    </th>
                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 10%;">
                        Date Created
                    </th>
                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 14%;">
                        Actions
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="leadsTableBody">
                {% for lead in leads %}
                <tr class="lead-row hover:bg-gray-50" 
                    data-status="{{ lead.status or 'new' }}"
                    data-name="{{ (lead.name or '')|lower }}"
                    data-email="{{ (lead.email or '')|lower }}"
                    data-phone="{{ (lead.phone or '')|lower }}"
                    data-organization="{{ (lead.organization or '')|lower }}">
                    <td class="px-3 py-2">
                        <div class="text-xs font-medium text-gray-900 truncate">{{ lead.name or '-' }}</div>
                        <div class="text-xs text-gray-500 truncate">{{ lead.email or '-' }}</div>
                    </td>
                    <td class="px-3 py-2 text-xs text-gray-500 truncate">
                        {{ lead.phone or '-' }}
                    </td>
                    <td class="px-3 py-2 text-xs text-gray-500 truncate" title="{{ lead.organization or '-' }}">
                        {{ lead.organization or '-' }}
                    </td>
                    <td class="px-3 py-2">
                        {% if lead.interest_list and lead.interest_list|length > 0 %}
                            <div class="flex flex-wrap gap-0.5">
                                {% for item in lead.interest_list %}
                                    {% if item %}
                                    <span class="inline-flex px-1.5 py-0.5 text-xs font-medium rounded bg-gray-100 text-gray-700">
                                        {{ item }}
                                    </span>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% else %}
                            <span class="text-xs text-gray-400">-</span>
                        {% endif %}
                    </td>
                    <td class="px-3 py-2 text-xs text-gray-500 truncate" title="{{ lead.message or '-' }}">
                        {{ lead.message or '-' }}
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap">
                        {% if lead.status == 'new' %}
                        <span class="px-1.5 py-0.5 inline-flex text-xs leading-4 font-semibold rounded-full bg-blue-100 text-blue-800">
                            New
                        </span>
                        {% elif lead.status == 'replied' %}
                        <span class="px-1.5 py-0.5 inline-flex text-xs leading-4 font-semibold rounded-full bg-green-100 text-green-800">
                            Replied
                        </span>
                        {% elif lead.status == 'archived' %}
                        <span class="px-1.5 py-0.5 inline-flex text-xs leading-4 font-semibold rounded-full bg-gray-100 text-gray-800">
                            Archived
                        </span>
                        {% elif lead.status == 'converted' %}
                        <span class="px-1.5 py-0.5 inline-flex text-xs leading-4 font-semibold rounded-full bg-purple-100 text-purple-800">
                            Converted
                        </span>
                        {% else %}
                        <span class="px-1.5 py-0.5 inline-flex text-xs leading-4 font-semibold rounded-full bg-gray-100 text-gray-800">
                            {{ lead.status or 'New' }}
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-xs text-gray-500">
                        {{ lead.created_at.strftime('%Y/%m/%d') if lead.created_at else '-' }}
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap">
                        <div class="flex items-center space-x-1">
                            {% if lead.email %}
                            <a href="mailto:{{ lead.email }}" 
                                class="text-wetravel-cyan hover:text-wetravel-cyan-dark" 
                                title="Send Email">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                </svg>
                            </a>
                            {% endif %}
                            <!-- Actions Button -->
                            <button type="button" 
                                class="text-gray-400 hover:text-gray-600 focus:outline-none"
                                onclick="openActionModal({{ lead.id }}, '{{ lead.name or '' }}', '{{ lead.status or 'new' }}', '{{ lead.email or '' }}')">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="px-6 py-4 text-center text-sm text-gray-500">
                        No leads found.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h3 class="text-lg leading-6 font-medium text-gray-900 mt-5">Delete Lead</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500">
                    Are you sure you want to delete <span id="deleteLeadName" class="font-semibold"></span>? 
                    This action cannot be undone.
                </p>
            </div>
            <div class="items-center px-4 py-3">
                <button id="confirmDeleteLeadBtn"
                    class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-md w-full shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                    Delete
                </button>
                <button id="cancelDeleteLeadBtn"
                    class="mt-2 px-4 py-2 bg-gray-300 text-gray-800 text-sm font-medium rounded-md w-full shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Action Modal -->
<div id="actionModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Lead Actions</h3>
                <button onclick="closeActionModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="mb-4">
                <p class="text-sm text-gray-600">Lead: <span id="modalLeadName" class="font-semibold text-gray-900"></span></p>
            </div>
            <div class="space-y-2" id="actionButtons">
                <!-- Action buttons will be dynamically inserted here -->
            </div>
            <div class="mt-4 pt-4 border-t border-gray-200">
                <button onclick="closeActionModal()"
                    class="w-full px-4 py-2 bg-gray-300 text-gray-800 text-sm font-medium rounded-md shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const leadRows = document.querySelectorAll('.lead-row');

    function filterLeads() {
        const searchTerm = searchInput.value.toLowerCase();
        const statusValue = statusFilter.value;

        leadRows.forEach(row => {
            const status = row.getAttribute('data-status');
            const name = row.getAttribute('data-name');
            const email = row.getAttribute('data-email');
            const phone = row.getAttribute('data-phone');
            const organization = row.getAttribute('data-organization');

            const matchesSearch = !searchTerm || 
                name.includes(searchTerm) || 
                email.includes(searchTerm) || 
                phone.includes(searchTerm) || 
                organization.includes(searchTerm);
            
            const matchesStatus = statusValue === 'all' || status === statusValue;

            if (matchesSearch && matchesStatus) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    searchInput.addEventListener('input', filterLeads);
    statusFilter.addEventListener('change', filterLeads);
    
    // Close modal when clicking outside
    const actionModal = document.getElementById('actionModal');
    actionModal.addEventListener('click', function(event) {
        if (event.target === actionModal) {
            closeActionModal();
        }
    });
});

// Open action modal
function openActionModal(leadId, leadName, currentStatus, leadEmail) {
    const modal = document.getElementById('actionModal');
    const modalLeadName = document.getElementById('modalLeadName');
    const actionButtons = document.getElementById('actionButtons');
    
    modalLeadName.textContent = leadName || 'Unknown';
    
    // Clear previous buttons
    actionButtons.innerHTML = '';
    
    // Add status action buttons based on current status
    if (currentStatus !== 'replied') {
        const repliedBtn = document.createElement('button');
        repliedBtn.onclick = () => { updateLeadStatus(leadId, 'replied'); };
        repliedBtn.className = 'w-full flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md transition-colors text-left';
        repliedBtn.innerHTML = `
            <svg class="w-4 h-4 mr-2 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Mark as Replied
        `;
        actionButtons.appendChild(repliedBtn);
    }
    
    if (currentStatus !== 'converted') {
        const convertedBtn = document.createElement('button');
        convertedBtn.onclick = () => { updateLeadStatus(leadId, 'converted'); };
        convertedBtn.className = 'w-full flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md transition-colors text-left';
        convertedBtn.innerHTML = `
            <svg class="w-4 h-4 mr-2 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            Mark as Converted
        `;
        actionButtons.appendChild(convertedBtn);
    }
    
    if (currentStatus !== 'archived') {
        const archiveBtn = document.createElement('button');
        archiveBtn.onclick = () => { updateLeadStatus(leadId, 'archived'); };
        archiveBtn.className = 'w-full flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md transition-colors text-left';
        archiveBtn.innerHTML = `
            <svg class="w-4 h-4 mr-2 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
            </svg>
            Archive
        `;
        actionButtons.appendChild(archiveBtn);
    }
    
    if (currentStatus === 'archived') {
        const restoreBtn = document.createElement('button');
        restoreBtn.onclick = () => { updateLeadStatus(leadId, 'new'); };
        restoreBtn.className = 'w-full flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md transition-colors text-left';
        restoreBtn.innerHTML = `
            <svg class="w-4 h-4 mr-2 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Restore
        `;
        actionButtons.appendChild(restoreBtn);
    }
    
    // Add delete button (always available)
    const deleteBtn = document.createElement('button');
    deleteBtn.onclick = () => { 
        closeActionModal();
        openDeleteModal(leadId, leadName);
    };
    deleteBtn.className = 'w-full flex items-center px-4 py-2 text-sm text-red-600 hover:bg-red-50 rounded-md transition-colors text-left';
    deleteBtn.innerHTML = `
        <svg class="w-4 h-4 mr-2 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
        </svg>
        Delete
    `;
    actionButtons.appendChild(deleteBtn);
    
    modal.classList.remove('hidden');
}

// Close action modal
function closeActionModal() {
    const modal = document.getElementById('actionModal');
    modal.classList.add('hidden');
}

// Open delete confirmation modal
function openDeleteModal(leadId, leadName) {
    const deleteModal = document.getElementById('deleteModal');
    const deleteLeadName = document.getElementById('deleteLeadName');
    const confirmDeleteBtn = document.getElementById('confirmDeleteLeadBtn');
    const cancelDeleteBtn = document.getElementById('cancelDeleteLeadBtn');
    
    deleteLeadName.textContent = leadName || 'this lead';
    deleteModal.classList.remove('hidden');
    
    // Remove existing event listeners by cloning and replacing buttons
    const newConfirmBtn = confirmDeleteBtn.cloneNode(true);
    const newCancelBtn = cancelDeleteBtn.cloneNode(true);
    confirmDeleteBtn.parentNode.replaceChild(newConfirmBtn, confirmDeleteBtn);
    cancelDeleteBtn.parentNode.replaceChild(newCancelBtn, cancelDeleteBtn);
    
    // Add new event listeners
    newConfirmBtn.addEventListener('click', async function() {
        await deleteLead(leadId);
    });
    
    newCancelBtn.addEventListener('click', function() {
        closeDeleteModal();
    });
    
    // Close modal when clicking outside
    deleteModal.addEventListener('click', function(event) {
        if (event.target === deleteModal) {
            closeDeleteModal();
        }
    });
}

// Close delete modal
function closeDeleteModal() {
    const deleteModal = document.getElementById('deleteModal');
    deleteModal.classList.add('hidden');
}

// Delete Lead
async function deleteLead(leadId) {
    try {
        const response = await fetch(`/admin/customers/leads/${leadId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        if (data.success) {
            closeDeleteModal();
            if (typeof showToast === 'function') {
                showToast('Lead deleted successfully!', 'success');
            }
            // Reload after delay to show toast
            setTimeout(() => {
                location.reload();
            }, 500);
        } else {
            if (typeof showToast === 'function') {
                showToast('Error: ' + (data.message || 'Delete failed'), 'error');
            }
        }
    } catch (error) {
        console.error('Error deleting lead:', error);
        if (typeof showToast === 'function') {
            showToast('Error: Delete failed, please try again', 'error');
        }
    }
}

// Update Lead status
async function updateLeadStatus(leadId, newStatus) {
    try {
        const response = await fetch(`/admin/customers/leads/${leadId}/update-status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status: newStatus })
        });
        
        const data = await response.json();
        if (data.success) {
            closeActionModal();
            if (typeof showToast === 'function') {
                showToast('Status updated successfully!', 'success');
            }
            // Reload after delay to show toast
            setTimeout(() => {
                location.reload();
            }, 500);
        } else {
            if (typeof showToast === 'function') {
                showToast('Error: ' + (data.message || 'Update failed'), 'error');
            }
        }
    } catch (error) {
        console.error('Error updating lead status:', error);
        if (typeof showToast === 'function') {
            showToast('Error: Update failed, please try again', 'error');
        }
    }
}
</script>

{% endblock %}