# 部署指南

本文档详细说明 NH Tours 项目的部署流程和服务器配置。

## 目录

- [环境准备](#环境准备)
- [部署方式](#部署方式)
- [Nginx 配置](#nginx-配置)
- [环境变量](#环境变量)
- [故障排查](#故障排查)

---

## 环境准备

### 系统要求

| 组件 | 最低版本 |
|------|----------|
| Python | 3.9+ |
| Node.js | 16+ (构建 Tailwind) |
| Nginx | 1.18+ |
| PostgreSQL | 13+ (生产环境) |

### 依赖安装

```bash
# 克隆项目
git clone <repo-url>
cd nhtours-website

# 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/Mac
# 或
.\venv\Scripts\activate   # Windows

# 安装依赖
pip install -r requirements.txt

# 安装前端依赖（如果需要构建 CSS）
npm install
npm run build:css
```

---

## 部署方式

### 方式一：传统服务器部署

#### 1. 配置环境变量

```bash
# 创建 .env 文件
cp .env.example .env

# 编辑配置
nano .env
```

#### 2. 数据库迁移

```bash
cd flask-app
flask db upgrade
```

#### 3. 启动应用

**开发环境**:
```bash
python run.py
```

**生产环境（使用 Gunicorn）**:
```bash
gunicorn -w 4 -b 0.0.0.0:8000 "app:create_app()"
```

#### 4. 配置 Systemd 服务

```ini
# /etc/systemd/system/nhtours.service
[Unit]
Description=NH Tours Flask Application
After=network.target

[Service]
User=www-data
Group=www-data
WorkingDirectory=/var/www/nhtours/flask-app
Environment="PATH=/var/www/nhtours/venv/bin"
EnvironmentFile=/var/www/nhtours/.env
ExecStart=/var/www/nhtours/venv/bin/gunicorn -w 4 -b 127.0.0.1:8000 "app:create_app()"
Restart=always

[Install]
WantedBy=multi-user.target
```

```bash
# 启用服务
sudo systemctl daemon-reload
sudo systemctl enable nhtours
sudo systemctl start nhtours
```

### 方式二：Docker 部署

#### Dockerfile

```dockerfile
FROM python:3.11-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY flask-app/ ./flask-app/
COPY .env .

WORKDIR /app/flask-app

EXPOSE 8000

CMD ["gunicorn", "-w", "4", "-b", "0.0.0.0:8000", "app:create_app()"]
```

#### docker-compose.yml

```yaml
version: '3.8'

services:
  web:
    build: .
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://user:pass@db:5432/nhtours
      - SECRET_KEY=${SECRET_KEY}
    depends_on:
      - db

  db:
    image: postgres:15
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
      - POSTGRES_DB=nhtours

  nginx:
    image: nginx:latest
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - web

volumes:
  postgres_data:
```

### 方式三：Heroku/PaaS 部署

#### Procfile

```
web: gunicorn -w 4 "app:create_app()"
```

#### 部署步骤

```bash
# 登录 Heroku
heroku login

# 创建应用
heroku create nhtours

# 添加 PostgreSQL
heroku addons:create heroku-postgresql:mini

# 设置环境变量
heroku config:set SECRET_KEY=your-secret-key
heroku config:set STRIPE_SECRET_KEY=sk_live_xxx

# 部署
git push heroku main

# 数据库迁移
heroku run flask db upgrade
```

---

## Nginx 配置

### 基础配置

```nginx
# /etc/nginx/sites-available/nhtours
server {
    listen 80;
    server_name nhtours.com www.nhtours.com;
    
    # HTTP 重定向到 HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name nhtours.com www.nhtours.com;

    # SSL 证书
    ssl_certificate /etc/letsencrypt/live/nhtours.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/nhtours.com/privkey.pem;
    
    # SSL 优化
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;

    # 静态文件
    location /static/ {
        alias /var/www/nhtours/flask-app/app/static/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # 上传文件
    location /uploads/ {
        alias /var/www/nhtours/flask-app/app/uploads/;
        expires 7d;
    }

    # 反向代理到 Flask
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket 支持（如果需要）
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Gzip 压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml;
    gzip_min_length 1000;
}
```

### 启用站点

```bash
sudo ln -s /etc/nginx/sites-available/nhtours /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### SSL 证书（Let's Encrypt）

```bash
# 安装 Certbot
sudo apt install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d nhtours.com -d www.nhtours.com

# 自动续期
sudo certbot renew --dry-run
```

---

## 环境变量

### 必需变量

| 变量 | 说明 | 示例 |
|------|------|------|
| `SECRET_KEY` | Flask 密钥 | 随机字符串 |
| `DATABASE_URL` | 数据库连接 | `postgresql://user:pass@host/db` |
| `STRIPE_SECRET_KEY` | Stripe 密钥 | `sk_live_xxx` |
| `STRIPE_PUBLIC_KEY` | Stripe 公钥 | `pk_live_xxx` |
| `STRIPE_WEBHOOK_SECRET` | Webhook 签名 | `whsec_xxx` |

### 可选变量

| 变量 | 说明 | 默认值 |
|------|------|--------|
| `FLASK_ENV` | 运行环境 | `production` |
| `AWS_ACCESS_KEY_ID` | AWS 密钥 | - |
| `AWS_SECRET_ACCESS_KEY` | AWS 密钥 | - |
| `AWS_SES_REGION` | SES 区域 | `us-east-1` |
| `MAIL_SENDER` | 发件邮箱 | - |

### .env 文件示例

```bash
# Flask
SECRET_KEY=your-very-long-random-secret-key
FLASK_ENV=production

# Database
DATABASE_URL=postgresql://nhtours:password@localhost:5432/nhtours

# Stripe
STRIPE_SECRET_KEY=sk_live_xxxxxxxxxxxxx
STRIPE_PUBLIC_KEY=pk_live_xxxxxxxxxxxxx
STRIPE_WEBHOOK_SECRET=whsec_xxxxxxxxxxxxx

# AWS SES
AWS_ACCESS_KEY_ID=AKIAXXXXXXXX
AWS_SECRET_ACCESS_KEY=xxxxxxxxxxxxxxxx
AWS_SES_REGION=us-east-1
MAIL_SENDER=noreply@nhtours.com
```

---

## 故障排查

### 常见问题

#### 1. 应用无法启动

```bash
# 检查日志
sudo journalctl -u nhtours -f

# 检查端口占用
sudo netstat -tlnp | grep 8000
```

#### 2. 静态文件 404

```bash
# 检查文件权限
ls -la /var/www/nhtours/flask-app/app/static/

# 检查 Nginx 配置
sudo nginx -t
```

#### 3. 数据库连接失败

```bash
# 测试连接
psql -h localhost -U nhtours -d nhtours

# 检查 PostgreSQL 状态
sudo systemctl status postgresql
```

#### 4. Stripe Webhook 失败

```bash
# 检查签名
# 确保 STRIPE_WEBHOOK_SECRET 正确

# 本地测试
stripe listen --forward-to localhost:5000/webhook/stripe
```

### 日志位置

| 服务 | 日志路径 |
|------|----------|
| Flask | `journalctl -u nhtours` |
| Nginx | `/var/log/nginx/error.log` |
| PostgreSQL | `/var/log/postgresql/` |

### 性能优化

1. **Gunicorn Workers**: 设置为 CPU 核心数 × 2 + 1
2. **静态文件缓存**: Nginx 设置 `expires 30d`
3. **数据库连接池**: SQLAlchemy 配置 `pool_size`
4. **Gzip 压缩**: Nginx 启用 gzip

---

## 部署检查清单

- [ ] 环境变量已配置
- [ ] 数据库已迁移
- [ ] SSL 证书已安装
- [ ] Nginx 配置已测试
- [ ] Stripe Webhook 已配置
- [ ] 静态文件可访问
- [ ] 日志正常记录
- [ ] 自动重启已配置

---

## 更新日期

**最后更新**: 2026-01-21
