# 任务追踪

本文档记录 NH Tours 项目的功能完成状态和待办事项。

## 目录

- [Phase 1 完成状态](#phase-1-完成状态)
- [Phase 2 功能状态](#phase-2-功能状态)
- [待办事项](#待办事项)
- [已知问题](#已知问题)

---

## Phase 1 完成状态

Phase 1 目标：将静态 HTML 网站重构为 Flask 动态应用。

### 已完成 ✅

| 任务 | 说明 |
|------|------|
| Flask 项目结构 | Application Factory + Blueprints |
| 模板迁移 | 45 个页面迁移到 Jinja2 |
| 模板继承 | base.html + 页面模板 |
| 静态资源组织 | CSS/JS/Images 结构化 |
| Nginx 配置 | 反向代理 + 静态文件服务 |
| SSL 配置 | Let's Encrypt 证书 |
| Contact 表单 | Lead 数据存储 |

---

## Phase 2 功能状态

Phase 2 目标：构建 WeTravel 风格的后台管理系统。

### 后台管理 - Admin

| 功能 | 状态 | 说明 |
|------|------|------|
| 仪表盘 | ✅ 完成 | 基础统计展示 |
| 行程列表 | ✅ 完成 | 卡片视图 + 筛选 |
| 日历视图 | ✅ 完成 | FullCalendar 集成 |
| 客户管理 | ✅ 完成 | Customers / Leads 列表 |
| 财务报表 | ✅ 完成 | Reports 页面 |
| 数据导出 | ✅ 完成 | Excel 导出 |

### Trip Builder - 行程构建器

| 步骤 | 状态 | 说明 |
|------|------|------|
| Step 1 基础信息 | ✅ 完成 | 标题、日期、封面图 |
| Step 2 描述 | ✅ 完成 | Quill 富文本编辑器 |
| Step 3 套餐管理 | ✅ 完成 | 价格、支付计划配置 |
| Step 4 附加选项 | ✅ 完成 | Add-ons 管理 |
| Step 5 购买者信息 | ✅ 完成 | 字段配置 |
| Step 6 参与者问卷 | ✅ 完成 | 自定义问题 |
| Step 7 折扣码 | ✅ 完成 | 创建/管理折扣码 |

### 报名付款 - Booking Flow

| 功能 | 状态 | 说明 |
|------|------|------|
| 套餐选择 | ✅ 完成 | Step 1 |
| 附加选项 | ✅ 完成 | Step 2 |
| 参与者信息 | ✅ 完成 | Step 3 动态表单 |
| 购买者信息 | ✅ 完成 | Step 4 |
| 支付页面 | ✅ 完成 | Step 5 Stripe Payment Element |
| 支付成功页 | ✅ 完成 | 确认信息展示 |
| 折扣码应用 | ✅ 完成 | 验证 + 计算 |

### 支付系统 - Payments

| 功能 | 状态 | 说明 |
|------|------|------|
| Stripe PaymentIntent | ✅ 完成 | 创建/更新 |
| Payment Element | ✅ 完成 | 前端集成 |
| Webhook 处理 | ✅ 完成 | 幂等性保证 |
| 定金支付 | ✅ 完成 | deposit 模式 |
| 分期付款 | ✅ 完成 | installment 记录 |
| Payoff 付清 | ✅ 完成 | 一次性结清 |
| 退款功能 | ✅ 完成 | 全款/部分退款 |
| 手续费计算 | ✅ 完成 | 按卡类型计算 |

### 订单管理 - Booking Management

| 功能 | 状态 | 说明 |
|------|------|------|
| 订单列表 | ✅ 完成 | 搜索、筛选、分页 |
| 订单详情 | ✅ 完成 | 参与者、支付记录 |
| 收据生成 | ✅ 完成 | HTML 收据页面 |
| 退款操作 | ✅ 完成 | 后台发起退款 |

### 邮件通知 - Email

| 功能 | 状态 | 说明 |
|------|------|------|
| AWS SES 集成 | ✅ 完成 | boto3 SDK |
| 支付确认邮件 | ✅ 完成 | 模板完成 |
| 分期提醒邮件 | ✅ 完成 | 到期前提醒 |
| Contact 表单通知 | ✅ 完成 | Lead 通知 |

---

## 待办事项

### 高优先级

| 任务 | 说明 | 预计工作量 |
|------|------|-----------|
| 分期付款页面优化 | 创建独立的 `pay_installment.html` 模板 | 小 |
| AWS SES 生产配置 | 验证发件域名，移出沙箱 | 小 |
| PendingBooking 自动清理 | 过期订单自动取消（24小时） | 小 |

### 中优先级

| 任务 | 说明 | 预计工作量 |
|------|------|-----------|
| 团队权限管理 | 多用户角色（Admin/Staff） | 中 |
| 自动化测试 | Pytest 单元测试和集成测试 | 大 |
| 性能优化 | 数据库查询优化、缓存 | 中 |

### 低优先级

| 任务 | 说明 | 预计工作量 |
|------|------|-----------|
| 多语言支持 | i18n 国际化 | 大 |
| API 文档 | Swagger/OpenAPI | 中 |
| 移动端优化 | 响应式改进 | 中 |

---

## 已知问题

### 需要修复

| 问题 | 严重程度 | 状态 |
|------|----------|------|
| 历史数据手续费问题 | 中 | ✅ 已修复 |
| 支付页面偶发卡顿 | 低 | 待排查 |

### 技术债务

| 问题 | 说明 |
|------|------|
| JavaScript 代码组织 | 部分逻辑需要模块化 |
| 表单验证重复 | 前后端验证需统一 |
| 错误处理不完整 | 部分 API 缺少详细错误信息 |

---

## 里程碑

### Phase 1 ✅ 已完成
- 静态网站迁移
- Flask 基础架构
- 部署配置

### Phase 2 ✅ 核心功能完成
- Trip Builder
- Booking Flow
- 支付系统
- 后台管理

### Phase 3 📋 规划中
- 团队协作功能
- 高级报表
- 移动端优化

---

## 更新日期

**最后更新**: 2026-01-21
