# 架构与规范

本文档定义项目的目录结构、编码规范和开发协作规则。

## 目录

- [目录结构](#目录结构)
- [编码规范](#编码规范)
- [设计模式](#设计模式)
- [开发协作规则](#开发协作规则)

---

## 目录结构

```
flask-app/
├── app/
│   ├── admin/              # 后台管理蓝图 (Routes & Forms)
│   │   ├── __init__.py
│   │   ├── routes.py       # 后台路由
│   │   └── forms.py        # 后台表单
│   ├── auth/               # 认证蓝图 (Login/Logout)
│   ├── main/               # 前台公共页面蓝图
│   ├── templates/          # Jinja2 模板
│   │   ├── admin/          # 后台模板 (WeTravel style)
│   │   ├── booking/        # 预订相关模板
│   │   ├── emails/         # 邮件模板
│   │   └── includes/       # 公共组件
│   ├── static/             # 静态资源
│   │   ├── css/            # CSS 文件
│   │   ├── js/             # JavaScript 文件
│   │   ├── images/         # 图片资源
│   │   └── fonts/          # 字体文件
│   ├── models.py           # 数据库模型 (SQLAlchemy)
│   ├── payments.py         # Stripe 支付逻辑
│   ├── tasks.py            # 定时任务
│   ├── utils.py            # 工具函数
│   └── __init__.py         # App Factory
├── migrations/             # 数据库迁移脚本
├── context/                # 项目文档
├── run.py                  # 启动入口
├── config.py               # 配置文件
└── requirements.txt        # Python 依赖
```

---

## 编码规范

### Python

- 遵循 **PEP 8** 风格指南
- 使用 **Type Hinting** 增加代码可读性
- 使用 **工厂模式**: 始终通过 `create_app()` 创建应用实例
- 使用 **蓝图组织**: 路由按功能模块（Admin, Auth, Main）划分

```python
# 示例：函数定义
def calculate_booking_total(booking: Booking) -> dict:
    """
    计算 Booking 的总金额
    
    Args:
        booking: Booking 对象
        
    Returns:
        dict: 包含 subtotal, discount, total 等字段
    """
    pass
```

### 命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| Python 文件 | 小写 + 下划线 | `admin_routes.py` |
| Python 类 | 大驼峰 | `BookingParticipant` |
| Python 函数/变量 | 小写 + 下划线 | `calculate_fee()` |
| HTML 文件 | 小写 + 连字符 | `trip-detail.html` |
| URL 路由 | 小写 + 连字符 | `/admin/trips/new` |
| JavaScript 变量 | 驼峰 | `bookingData` |
| CSS 类 | Tailwind 风格或 BEM | `btn-primary` |

### HTML/CSS (前端)

- **Tailwind CSS**: 优先使用 Utility Classes，避免手写原生 CSS
- **WeTravel Theme 扩展**:
  - Primary Cyan: `text-wetravel-cyan`, `bg-wetravel-cyan` (#00D1C1)
  - Secondary Green: `wetravel-green` (#4ADE80)
- **Jinja2**:
  - 继承 `base_wetravel.html` 用于后台页面
  - 使用 `{% block %}` 分离内容区域

### JavaScript

- **Vanilla JS**: 保持简单，直接操作 DOM，不使用重型框架
- **No Inline JS**: 将 JS 代码放在 `{% block scripts %}` 或单独文件
- **Data Passing**: 后端数据通过 `data-*` 属性或隐藏 Input 传递

```html
<!-- 示例：后端数据传递 -->
<input type="hidden" id="trip-data" value='{{ trip_json | safe }}'>
```

---

## 设计模式

### Flask 应用工厂模式

```python
# app/__init__.py
def create_app(config_name=None):
    app = Flask(__name__)
    app.config.from_object(config[config_name])
    
    # 注册蓝图
    from app.admin import routes as admin_routes
    app.register_blueprint(admin_routes.bp, url_prefix='/admin')
    
    return app
```

### Trip Builder 分步向导模式

Trip Builder 采用 **Stepper 模式**：

1. **State Management**: 每步提交 Form，数据保存到 Trip 或关联表
2. **Validation**: 后端 WTForms 验证 + 前端 HTML5/JS 验证
3. **JSON Handling**: 复杂数据（支付计划、问卷）在前端组装为 JSON，存入 Hidden Input

### 数据库操作

- 所有数据库操作通过 **SQLAlchemy ORM** 进行，禁止手写 SQL
- 合理配置 `backref` 和 `lazy='dynamic'` 优化查询性能

---

## 开发协作规则

### 核心规则：操作前必须沟通确认

在进行任何代码修改前，必须：

1. **充分理解需求**
   - 仔细阅读用户需求描述
   - 理解期望的功能和效果
   - 识别关键细节和约束条件

2. **主动提问和澄清**
   - 对不明确的需求主动提问
   - 对复杂功能询问实现方式和优先级
   - 对技术选型说明理由并征求确认

3. **制定详细规划**
   - 在编码前制定详细实现计划
   - 说明实现思路、技术方案、影响范围
   - 列出需要修改的文件和可能的风险点

4. **获得明确确认**
   - 等待用户明确确认后才开始实施
   - 如用户提出修改意见，重新规划并获得确认

5. **禁止擅自行动**
   - 严禁未经确认直接修改代码
   - 严禁假设用户意图自行实现

### 代码修改流程

```
用户提出需求
    ↓
AI 理解需求，提出澄清问题
    ↓
AI 制定详细规划
    ↓
用户确认规划
    ↓
AI 执行代码修改
    ↓
展示效果，等待用户确认
    ↓
更新相关文档
```

### 文档同步规则

**每次操作完成后，必须更新相应的 context 文档**：

| 修改类型 | 需更新的文档 |
|----------|-------------|
| 数据库变更 | `02_数据库设计.md` |
| 路由变更 | `04_API参考.md` |
| 功能完成 | `08_任务追踪.md` |
| UI/设计变更 | `05_UI设计系统.md` |
| 重要决策 | `07_开发日志.md` |

### 代码质量规则

#### 消除代码重复

- HTML 模板：使用 `{% include %}` 或 `{% extends %}`
- JavaScript：提取为独立函数或模块
- Python：提取公共函数到 utils 模块

#### 每次改动必须提供验证步骤

```
验证步骤：
1. 启动 Flask 应用: python run.py
2. 访问 http://localhost:5000/admin/trips
3. 预期结果: 行程列表正常显示
4. 检查浏览器控制台: 无 JavaScript 错误
```

#### 失败则回滚

- 验证失败时立即回滚到稳定状态
- 回滚后确认系统恢复正常
- 记录失败原因，制定新方案

### 安全规则

- 所有表单必须包含 **CSRF token** 保护
- 所有用户输入必须验证
- 所有输出必须转义（Jinja2 自动转义）
- 敏感信息使用环境变量管理

### Git 提交规范

```
[模块] 简短描述

详细说明：
- 改动内容
- 改动原因
- 影响范围

验证: 启动应用，检查功能正常
```

---

## 更新日期

**最后更新**: 2026-01-21
