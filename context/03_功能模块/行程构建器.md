# 行程构建器 (Trip Builder)

Trip Builder 是后台管理系统的核心功能，提供 6 步向导式界面用于创建和编辑行程。

## 目录

- [概述](#概述)
- [步骤详解](#步骤详解)
- [技术实现](#技术实现)
- [数据结构](#数据结构)

---

## 概述

### 功能定位

Trip Builder 让管理员能够：
- 创建新行程并设置价格方案
- 配置报名表单和参与者问卷
- 管理折扣码
- 发布行程供客户报名

### 设计原则

- **分步引导**: 复杂表单拆分为 6 步，降低认知负担
- **即时保存**: 每步提交自动保存，支持中途退出
- **灵活配置**: 支持多套餐、多支付方式、自定义问题

---

## 步骤详解

### Step 1: 基础信息

| 字段 | 必填 | 说明 |
|------|------|------|
| 行程标题 | ✅ | 显示在列表和详情页 |
| Slug | ✅ | URL 友好的唯一标识 |
| 开始日期 | ✅ | 行程开始时间 |
| 结束日期 | ✅ | 行程结束时间 |
| 封面图片 | ✅ | Hero Image |
| 最大人数 | ✅ | 容量限制 |
| 日历颜色 | - | 日历视图显示颜色 |

### Step 2: 详细描述

| 字段 | 必填 | 说明 |
|------|------|------|
| 行程描述 | - | Quill 富文本编辑器 |
| 包含项 | - | 动态列表（trip_includes） |
| 不包含项 | - | 动态列表（trip_excludes） |

**技术细节**:
- 使用 Quill.js 提供富文本编辑
- 包含/不包含项存储为 JSON 数组

### Step 3: 套餐管理

每个行程可配置多个套餐：

| 字段 | 说明 |
|------|------|
| 套餐名称 | 如 "标准套餐"、"VIP 套餐" |
| 价格 | 单价金额 |
| 货币 | USD / CNY / CAD |
| 库存 | 可选，限制该套餐销量 |
| 报名截止 | 超过此日期不可报名 |

**支付计划配置**:

```json
{
  "enabled": true,
  "deposit_amount": 500,
  "installments": [
    {"date": "2025-06-01", "amount": 1000},
    {"date": "2025-07-01", "amount": 1000}
  ],
  "enable_auto_billing": false
}
```

### Step 4: 附加选项 (Add-ons)

可选的增值服务：

| 字段 | 说明 |
|------|------|
| 名称 | 如 "单房差"、"接机服务" |
| 价格 | 单价 |
| 描述 | 简短说明 |
| 库存 | 可选限制 |

### Step 5: 购买者信息

配置报名时需要收集的购买者信息：

| 配置项 | 说明 |
|--------|------|
| 标准字段 | First Name, Last Name, Email, Phone 等 |
| 紧急联系人 | 可选开启 |
| 自定义字段 | 动态添加任意问题 |

**BuyerInfoField 模型**:
- `field_type`: text / textarea / select / checkbox / radio
- `options`: 选项配置（用于 select/radio）
- `is_required`: 是否必填

### Step 6: 参与者问卷

为每位参与者配置需回答的问题：

| 字段类型 | 说明 |
|----------|------|
| text | 单行文本 |
| textarea | 多行文本 |
| select | 下拉选择 |
| checkbox | 多选 |
| radio | 单选 |
| date | 日期选择 |
| file | 文件上传 |

### Step 7: 折扣码

管理本行程可用的折扣码：

| 字段 | 说明 |
|------|------|
| 折扣码 | 唯一字符串 |
| 类型 | percentage / fixed |
| 金额 | 折扣比例或固定金额 |
| 使用次数 | 限制总使用次数 |
| 过期日期 | 有效期限 |

---

## 技术实现

### 前端架构

```
templates/admin/
├── trip_builder/
│   ├── step1.html      # 基础信息表单
│   ├── step2.html      # 描述编辑
│   ├── step3.html      # 套餐管理
│   ├── step4.html      # 附加选项
│   ├── step5.html      # 购买者信息
│   ├── step6.html      # 参与者问卷
│   └── step7.html      # 折扣码
└── trip_builder_base.html  # 公共布局（导航、进度条）
```

### 后端路由

| 路由 | 方法 | 功能 |
|------|------|------|
| `/admin/trips/new` | GET | 创建新行程，跳转 Step 1 |
| `/admin/trips/<id>/edit/step/<n>` | GET | 显示步骤 n 表单 |
| `/admin/trips/<id>/edit/step/<n>` | POST | 保存步骤 n 数据 |

### 数据流

```
用户填写表单
    ↓
前端验证 (HTML5 + JavaScript)
    ↓
POST 提交到后端
    ↓
WTForms 验证
    ↓
保存到 Trip / TripPackage / CustomQuestion 等表
    ↓
重定向到下一步或返回表单显示错误
```

### JavaScript 模块

关键 JavaScript 功能：

1. **动态列表管理**: 添加/删除包含项、附加选项
2. **Quill 富文本**: 初始化编辑器，同步内容到 hidden input
3. **支付计划配置**: 动态添加分期日期和金额
4. **表单验证**: 实时提示必填项

---

## 数据结构

### Trip 表关键字段

```python
class Trip(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    title = db.Column(db.String(200), nullable=False)
    slug = db.Column(db.String(200), unique=True)
    status = db.Column(db.String(20), default='draft')
    
    start_date = db.Column(db.Date)
    end_date = db.Column(db.Date)
    capacity = db.Column(db.Integer, default=20)
    
    description = db.Column(db.Text)
    trip_includes = db.Column(db.Text)  # JSON array
    trip_excludes = db.Column(db.Text)  # JSON array
    
    hero_image = db.Column(db.String(500))
    color = db.Column(db.String(7))
    
    # Relationships
    packages = db.relationship('TripPackage', backref='trip', lazy='dynamic')
    addons = db.relationship('TripAddOn', backref='trip', lazy='dynamic')
    questions = db.relationship('CustomQuestion', backref='trip', lazy='dynamic')
```

### 支付计划配置示例

**全款支付**:
```json
{
  "enabled": false
}
```

**分期支付**:
```json
{
  "enabled": true,
  "deposit_amount": 500,
  "installments": [
    {"date": "2025-06-01", "amount": 1000},
    {"date": "2025-07-01", "amount": 860}
  ],
  "enable_auto_billing": false
}
```

---

## 更新日期

**最后更新**: 2026-01-21
