# 报名付款系统

本文档详细说明 NH Tours 的预订流程和 Stripe 支付集成。

## 目录

- [系统概述](#系统概述)
- [报名流程](#报名流程)
- [支付流程](#支付流程)
- [Stripe 集成](#stripe-集成)
- [Webhook 处理](#webhook-处理)
- [金额计算逻辑](#金额计算逻辑)
- [测试指南](#测试指南)

---

## 系统概述

### 设计原则

1. **延迟创建**: 正式 Booking 记录在支付成功后才创建
2. **幂等处理**: Webhook 可能重复触发，需防止重复创建
3. **手续费分离**: `amount_paid` 只记录基础金额，不含 Stripe 手续费

### 核心状态流转

```
客户开始报名
    ↓
PendingBooking 创建 (status: pending)
    ↓
Stripe PaymentIntent 创建
    ↓
客户完成支付
    ↓
Webhook 触发
    ↓
Booking 创建 (status: deposit_paid / fully_paid)
PendingBooking 更新 (status: completed)
Payment 记录创建
```

---

## 报名流程

### 5 步向导界面

| 步骤 | 页面 | 功能 |
|------|------|------|
| Step 1 | 套餐选择 | 选择套餐和数量 |
| Step 2 | 附加选项 | 选择 Add-ons |
| Step 3 | 参与者信息 | 填写每位参与者资料 |
| Step 4 | 购买者信息 | 填写付款人资料 |
| Step 5 | 支付 | 选择支付方式，完成支付 |

### 数据流

```
前端收集数据
    ↓
POST /api/payment/intent
    ↓
后端创建 PendingBooking
后端创建 Stripe PaymentIntent
    ↓
返回 client_secret
    ↓
前端使用 Stripe Payment Element 完成支付
    ↓
支付成功 → 调用 /api/payment/status 轮询状态
    ↓
Webhook 异步处理 → 创建 Booking/Payment
```

### 前端模板

```
templates/booking/
├── flow.html              # 报名主页面（5步向导容器）
├── payment_pending.html   # 支付处理中页面
└── success.html           # 支付成功页面
```

---

## 支付流程

### 支付方式选择

| 方式 | 说明 | 手续费 |
|------|------|--------|
| 全款支付 | 一次性支付总额 | 按卡类型计算 |
| 定金 + 分期 | 先付定金，后续分期 | 每笔单独计算 |

### 手续费计算

仅信用卡收取手续费，借记卡不收：

| 卡类型 | 费率 |
|--------|------|
| American Express | 3.5% |
| Visa / Mastercard | 2.9% |
| Debit Card | 0% |

```python
def calculate_fee(base_amount_cents, funding, brand):
    """
    计算 Stripe 手续费
    - funding: 'credit' / 'debit'
    - brand: 'amex' / 'visa' / 'mastercard'
    """
    if funding != 'credit':
        return 0
    
    if brand == 'amex':
        rate = 0.035
    else:
        rate = 0.029
    
    return round(base_amount_cents * rate)
```

---

## Stripe 集成

### PaymentIntent 创建

```python
# POST /api/payment/intent
def api_payment_intent():
    data = request.get_json()
    
    # 1. 创建或更新 PendingBooking
    pending = PendingBooking(
        trip_id=trip_id,
        booking_data=json.dumps(booking_data),
        status='pending',
        expires_at=datetime.utcnow() + timedelta(hours=24)
    )
    
    # 2. 创建 Stripe PaymentIntent
    intent = stripe.PaymentIntent.create(
        amount=amount_cents,
        currency='usd',
        automatic_payment_methods={'enabled': True},
        metadata={
            'pending_booking_id': str(pending.id),
            'base_amount': str(base_amount_cents),
            'fee': str(fee_cents)
        }
    )
    
    # 3. 返回 client_secret
    return jsonify({
        'clientSecret': intent.client_secret,
        'paymentIntentId': intent.id
    })
```

### Payment Element 前端集成

```javascript
// 初始化 Stripe
const stripe = Stripe(STRIPE_PUBLIC_KEY);
const elements = stripe.elements({ clientSecret });

// 挂载 Payment Element
const paymentElement = elements.create('payment');
paymentElement.mount('#payment-element');

// 确认支付
const { error } = await stripe.confirmPayment({
    elements,
    confirmParams: {
        return_url: window.location.origin + '/payment/pending'
    }
});
```

---

## Webhook 处理

### 监听事件

| 事件 | 处理函数 | 说明 |
|------|----------|------|
| `payment_intent.succeeded` | `handle_payment_intent_succeeded` | 支付成功 |
| `checkout.session.completed` | `handle_checkout_completed` | Checkout 完成 |

### payment_intent.succeeded 处理

```python
def handle_payment_intent_succeeded(payment_intent):
    """
    处理 PaymentIntent 成功事件
    
    关键逻辑：
    1. 从 metadata 获取 pending_booking_id
    2. 创建正式 Booking 记录
    3. 创建 Payment 记录（base_amount 不含手续费）
    4. 更新 PendingBooking 状态
    5. 发送确认邮件
    """
    metadata = payment_intent.get('metadata', {})
    pending_id = metadata.get('pending_booking_id')
    
    # 幂等检查
    existing = Payment.query.filter_by(
        stripe_payment_intent_id=payment_intent['id'],
        status='succeeded'
    ).first()
    if existing:
        return  # 已处理，跳过
    
    # 获取 PendingBooking
    pending = PendingBooking.query.get(pending_id)
    booking_data = json.loads(pending.booking_data)
    
    # 创建 Booking
    booking = _create_booking_from_metadata(booking_data, payment_intent)
    
    # 更新 PendingBooking
    pending.status = 'completed'
    pending.booking_id = booking.id
    
    db.session.commit()
```

### 金额字段说明

| 字段 | 位置 | 说明 |
|------|------|------|
| `base_amount_cents` | metadata | 基础金额（不含手续费） |
| `fee_cents` | metadata | 手续费金额 |
| `amount_total` | PaymentIntent | Stripe 收取的总金额 |

**重要**: `Booking.amount_paid` 只记录 `base_amount`，因为手续费是给 Stripe 的，不是我们的收入。

---

## 金额计算逻辑

### calculate_booking_total

```python
def calculate_booking_total(booking):
    """
    返回:
    - subtotal: 套餐 + 附加项
    - discount: 折扣金额
    - total: 净应付金额（subtotal - discount）
    - amount_paid: 已支付金额（不含手续费）
    - amount_due: 待支付金额
    """
    subtotal = 0.0
    
    # 套餐金额
    for bp in booking.booking_packages.all():
        subtotal += bp.package.price * bp.quantity
    
    # 附加项金额
    for addon in booking.addons.all():
        subtotal += addon.addon.price * addon.quantity
    
    # 折扣
    discount = booking.discount_amount or 0.0
    total = max(0.0, subtotal - discount)
    
    amount_paid = booking.amount_paid or 0.0
    amount_due = max(0.0, total - amount_paid)
    
    return {
        'subtotal': subtotal,
        'discount': discount,
        'total': total,
        'amount_paid': amount_paid,
        'amount_due': amount_due
    }
```

### 报表统计

| 指标 | 计算方式 | 说明 |
|------|----------|------|
| `amount_gross` | 套餐 + 附加项 | 原价总额 |
| `amount_discount` | sum(booking.discount_amount) | 折扣总额 |
| `amount_expected` | gross - discount | 应收金额 |
| `amount_paid` | sum(booking.amount_paid) | 已收金额（不含手续费） |
| `amount_available` | expected - paid | 待收金额 |

---

## 测试指南

### Stripe 测试卡号

| 卡号 | 类型 | 说明 |
|------|------|------|
| `4242424242424242` | Visa Credit | 成功支付 |
| `4000056655665556` | Visa Debit | 无手续费 |
| `378282246310005` | Amex | 3.5% 手续费 |
| `4000000000009995` | - | 余额不足失败 |

### 测试流程

1. **新建测试行程**: 设置套餐价格为整数（如 $1000）
2. **完成报名流程**: 使用测试卡支付
3. **验证 Booking**: 检查 `amount_paid` 是否为整数（不含手续费）
4. **验证 Payment**: 检查 `base_amount_cents` 和 `fee_cents`
5. **验证报表**: Reports 页面金额应正确

### 常见问题排查

| 问题 | 原因 | 解决 |
|------|------|------|
| amount_paid 含小数 | 历史数据包含手续费 | 运行数据修复脚本 |
| Webhook 未触发 | Stripe CLI 未运行 | 启动 `stripe listen` |
| 支付页面卡住 | PaymentIntent 失败 | 检查控制台错误 |

---

## 更新日期

**最后更新**: 2026-01-21
