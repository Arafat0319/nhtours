# 开发日志

本文档记录项目开发过程中的重要决策、问题修复和技术实现细节。按时间倒序排列。

---

## 2026-01-21

### 财务报表金额修复

**问题**: Reports 页面显示的 `amount_paid` 包含了 Stripe 手续费，导致金额不正确。

**原因分析**:
- `handle_checkout_completed` 使用 `amount_total`（含手续费）更新 `booking.amount_paid`
- 报表计算 `amount_expected` 时未扣除折扣金额

**解决方案**:
1. 修改 `handle_checkout_completed`: 从 metadata 获取 `base_amount`
2. 修改 `calculate_trip_stats`: 扣除 `discount_amount`
3. 执行数据修复脚本，更正历史数据

**影响文件**:
- `app/routes.py`
- `app/admin/routes.py`
- `app/payments.py`

---

## 2026-01-20

### 支付模块重构

**目标**: 实现延迟创建 Booking，支付成功后才生成正式记录。

**新增模型**: `PendingBooking`
- 临时存储预订数据
- 关联 `stripe_payment_intent_id`
- 24 小时后过期

**数据流**:
```
填写报名信息 → 创建 PendingBooking → 支付 → Webhook → 创建 Booking
```

**新增字段**:
- `Payment.base_amount_cents`
- `Payment.fee_cents`
- `Payment.final_amount_cents`

---

### 分期付款 Payoff 功能

**需求**: 允许客户一次性付清剩余款项。

**实现**:
- `payment_type: 'payoff'` 区分支付类型
- 取消所有 pending 的 `InstallmentPayment`
- 更新 `Booking.status = 'fully_paid'`

---

### 折扣码系统

**功能**:
- Trip Builder Step 7 管理折扣码
- 报名流程验证和应用折扣
- 支持百分比和固定金额两种类型

**数据结构**:
```python
DiscountCode(
    code='SAVE10',
    type='percentage',  # or 'fixed'
    amount=10,
    max_uses=100,
    used_count=0
)
```

---

## 2026-01-19

### Trip Builder 数据丢失修复

**问题**: 刷新页面后 Trip Builder 数据丢失。

**原因**: JavaScript 初始化时序问题，数据未正确恢复。

**解决方案**: 实现"双初始化"机制
1. 首次初始化：加载页面时从 hidden input 读取
2. DOM Ready 后：再次检查并恢复数据

---

### 报名表单验证优化

**改进**:
- 必填字段红星标记
- 实时验证反馈
- 错误时自动滚动到第一个错误字段
- 统一按钮宽度和布局

---

## 2026-01-18

### Order Summary 更新失败

**问题**: 切换步骤时 Order Summary 不更新。

**原因**: `saveAllStepsData()` 未正确触发 `updateOrderSummary()`。

**解决方案**: 在每个步骤数据变更后显式调用 `updateOrderSummary()`。

---

### 参与者信息持久化

**问题**: 切换套餐数量后参与者信息丢失。

**解决方案**: 修改 `updateParticipantCount()` 逻辑
1. 保存现有数据到临时变量
2. 重新生成表单
3. 恢复保存的数据

---

## 2026-01-17

### Stripe Payment Element 集成

**技术选型**: 使用 Payment Element 而非 Card Element

**优势**:
- 支持多种支付方式
- 自动处理 3D Secure
- 统一 UI 风格

**关键代码**:
```javascript
const elements = stripe.elements({ clientSecret });
const paymentElement = elements.create('payment');
paymentElement.mount('#payment-element');
```

---

### Webhook 处理幂等性

**问题**: Stripe Webhook 可能重复触发，导致数据重复。

**解决方案**:
```python
# 检查是否已处理
existing = Payment.query.filter_by(
    stripe_payment_intent_id=pi_id,
    status='succeeded'
).first()
if existing:
    return  # 跳过
```

---

## 2026-01-15

### 邮件发送集成（AWS SES）

**配置**:
- 使用 boto3 SDK
- 环境变量管理凭证
- HTML 和纯文本双版本

**函数签名**:
```python
def send_email_via_ses(sender, recipient, subject, html_body, text_body):
    pass
```

---

### FullCalendar 集成

**用途**: 行程日历视图

**功能**:
- 月/周视图切换
- 点击事件跳转行程详情
- 根据 `trip.color` 显示不同颜色

---

## 2026-01-10

### Trip Builder 基础架构

**设计决策**:
- 6 步向导式表单
- 每步独立提交，支持中途退出
- 复杂数据（支付计划、问卷）使用 JSON 存储

**步骤划分**:
1. 基础信息
2. 描述
3. 套餐管理
4. 附加选项
5. 购买者信息配置
6. 参与者问卷

---

## 2026-01-05

### 数据库模型设计

**核心关系**:
```
Trip → TripPackage (1:N)
Trip → Booking (1:N)
Booking → BookingParticipant (1:N)
Booking → Payment (1:N)
```

**设计原则**:
- 使用 SQLAlchemy ORM
- 合理配置 `lazy` 加载
- JSON 字段存储灵活数据

---

## Phase 1 完成记录

### 静态网站 → Flask 迁移

**完成内容**:
- 45 个 HTML 页面迁移到 Jinja2 模板
- 模板继承结构建立
- 静态资源组织
- Nginx 配置优化

**技术要点**:
- Flask Application Factory 模式
- Blueprint 路由组织
- 环境变量配置管理

---

## 更新日期

**最后更新**: 2026-01-21
